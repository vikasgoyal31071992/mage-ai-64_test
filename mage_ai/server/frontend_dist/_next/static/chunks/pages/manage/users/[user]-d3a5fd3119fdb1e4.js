(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4496],{14875:function(e,r,n){"use strict";n.d(r,{Z3:function(){return o},ms:function(){return i},s7:function(){return t}});var o=[{autoComplete:"username",label:"Username",required:!0,uuid:"username"},{autoComplete:"email",disabled:!1,label:"Email",required:!0,type:"email",uuid:"email"}],t="password_current",i=[{autoComplete:"current-password",label:"Current password",type:"password",uuid:t},{autoComplete:"new-password",label:"New password",type:"password",uuid:"password"},{autoComplete:"new-password",label:"Confirm new password",type:"password",uuid:"password_confirmation"}]},36043:function(e,r,n){"use strict";var o=n(82394),t=n(21831),i=n(75582),u=n(21764),s=n(82684),l=n(69864),a=n(71180),d=n(31882),c=n(55485),v=n(85854),p=n(44085),f=n(38276),m=n(30160),w=n(17488),b=n(35686),h=n(98464),j=n(82359),Z=n(14875),y=n(86735),O=n(50178),_=n(42122),g=n(72619),x=n(28598);function P(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,o)}return n}function C(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?P(Object(n),!0).forEach((function(r){(0,o.Z)(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}r.Z=function(e){var r=e.disabledFields,n=e.hideFields,P=e.newUser,k=e.onDeleteSuccess,S=e.onSaveSuccess,E=e.showDelete,D=e.title,I=e.user,M=(0,s.useState)(!0),T=M[0],U=M[1],N=(0,s.useState)({}),q=N[0],R=N[1],F=(0,s.useState)(null),A=F[0],L=F[1],B=((0,O.PR)()||{}).owner,G=b.ZP.statuses.list().data,W=(0,s.useMemo)((function(){var e;return(null===G||void 0===G||null===(e=G.statuses)||void 0===e?void 0:e[0])||{}}),[G]),H=W.project_type,X=W.project_uuid,Q="global",z=null,J=null;H===j.k.SUB?(Q="project",z=X):H===j.k.MAIN&&(J="The roles selected here will apply to this user globally.\n                If a user has both a global role and a workspace role,\n                then the role with higher access will take precedence.");var K=b.ZP.roles.list({entity:Q,entity_ids:z?[z]:[],limit_roles:!!P},{revalidateOnFocus:!1}),V=K.data,Y=(K.mutate,(0,s.useMemo)((function(){return(null===V||void 0===V?void 0:V.roles)||[]}),[null===V||void 0===V?void 0:V.roles])),$=(0,l.Db)(P?b.ZP.users.useCreate():b.ZP.users.useUpdate(null===I||void 0===I?void 0:I.id),{onSuccess:function(e){return(0,g.wD)(e,{callback:function(e){var r=e.user,n=Z.Z3.concat(Z.ms).map((function(e){return e.uuid}));n.push("id");var o=(0,_.GL)(r,n);L(o),u.Am.success(P?"New user created successfully.":"User profile successfully updated.",{position:u.Am.POSITION.BOTTOM_RIGHT,toastId:"user-update-success-".concat(r.id)}),null===S||void 0===S||S(o)},onErrorCallback:function(e){var r=e.error,n=r.errors,o=r.exception,t=r.message,i=r.type;u.Am.error((null===n||void 0===n?void 0:n.error)||o||t,{position:u.Am.POSITION.BOTTOM_RIGHT,toastId:i})}})}}),ee=(0,i.Z)($,2),re=ee[0],ne=ee[1].isLoading,oe=(0,l.Db)(b.ZP.users.useDelete(null===I||void 0===I?void 0:I.id),{onSuccess:function(e){return(0,g.wD)(e,{callback:function(){null===k||void 0===k||k()},onErrorCallback:function(e){var r=e.error,n=r.errors,o=r.message;alert(o),console.log(n)}})}}),te=(0,i.Z)(oe,2),ie=te[0],ue=te[1].isLoading,se=n?(0,t.Z)(n):[];P&&se.push(Z.s7);var le=!se||!se.includes(Z.s7),ae=(0,h.Z)(I);(0,s.useEffect)((function(){if(I&&(!A||(null===ae||void 0===ae?void 0:ae.id)!==(null===I||void 0===I?void 0:I.id))){var e=Z.Z3.concat(Z.ms).map((function(e){return e.uuid}));L((0,_.GL)(I,e))}null!==A&&void 0!==A&&A.password||null!==A&&void 0!==A&&A.password_confirmation?(null===A||void 0===A?void 0:A.password)!==(null===A||void 0===A?void 0:A.password_confirmation)?R({password_confirmation:"Password confirmation does not match."}):!le||null!==A&&void 0!==A&&A.password_current?R(null):R({password_current:"This field is required."}):null!==A&&void 0!==A&&A.password_current&&le?null!==A&&void 0!==A&&A.password&&null!==A&&void 0!==A&&A.password_confirmation?R(null):R({password:"This field is required.",password_confirmation:"This field is required."}):null!==A&&void 0!==A&&A.password_current||null!==A&&void 0!==A&&A.password||null!==A&&void 0!==A&&A.password_confirmation||R(null)}),[A,le,I,ae]);var de=(0,s.useState)(!1),ce=de[0],ve=de[1],pe=(0,s.useMemo)((function(){return(ce?null===A||void 0===A?void 0:A.roles_new:null===I||void 0===I?void 0:I.roles_new)||[]}),[A,ce,I]),fe=(0,s.useMemo)((function(){var e=(null===Y||void 0===Y?void 0:Y.map((function(e){return e.id})))||[];return null===pe||void 0===pe?void 0:pe.filter((function(r){var n=r.id;return e.includes(n)}))}),[pe,Y]);return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(v.Z,{children:D||"Edit profile"}),(0,x.jsxs)("form",{children:[Z.Z3.filter((function(e){var r=e.uuid;return!se||!se.includes(r)})).map((function(e){var r=e.autoComplete,n=e.disabled,t=e.label,i=e.required,u=e.type,s=e.uuid;return(0,x.jsx)(f.Z,{mt:2,children:(0,x.jsx)(w.Z,{autoComplete:r,disabled:n&&!P,label:t,onChange:function(e){U(!1),L((function(r){return C(C({},r),{},(0,o.Z)({},s,e.target.value))}))},primary:!0,required:i,setContentOnMount:!0,type:u,value:(null===A||void 0===A?void 0:A[s])||""})},s)})),!(null!==I&&void 0!==I&&I.owner)&&!(null!==se&&void 0!==se&&se.includes("roles"))&&(0,x.jsxs)(f.Z,{mt:2,children:[J&&(0,x.jsx)(f.Z,{mb:1,children:(0,x.jsx)(m.ZP,{children:J})}),(0,x.jsx)(p.Z,{disabled:null===r||void 0===r?void 0:r.includes("roles"),label:"Roles",onChange:function(e){var r=(0,y.sE)(Y,(function(r){return r.id==e.target.value}));r&&(U(!1),ve(!0),L((function(e){var n={};return(0,y.sE)(pe,(function(e){return e.id==(null===r||void 0===r?void 0:r.id)}))||(n={roles_new:[].concat((0,t.Z)(pe),[r])}),C(C({},e),n)})))},primary:!0,setContentOnMount:!0,children:Y.map((function(e){var r=e.id,n=e.name;return(0,x.jsx)("option",{value:r,children:n},n)}))}),(0,x.jsx)(f.Z,{mb:1}),(0,x.jsx)(c.ZP,{alignItems:"center",flexWrap:"wrap",children:null===fe||void 0===fe?void 0:fe.map((function(e){var n=e.id,o=e.name;return(0,x.jsx)(f.Z,{mb:1,mr:1,children:(0,x.jsx)(d.Z,{disabled:null===r||void 0===r?void 0:r.includes("roles"),label:o,onClick:function(){U(!1),ve(!0),L((function(e){return C(C({},e),{},{roles_new:(0,y.Od)(pe,(function(e){return e.id===n}))})}))},primary:!0})},"user_roles/".concat(o))}))})]}),(0,x.jsxs)(f.Z,{mt:5,children:[(0,x.jsx)(v.Z,{children:P?"Password":"Change password"}),Z.ms.filter((function(e){var r=e.uuid;return!se||!se.includes(r)})).map((function(e){var r=e.autoComplete,n=e.disabled,t=e.label,i=e.required,u=e.type,s=e.uuid;return(0,x.jsx)(f.Z,{mt:2,children:(0,x.jsx)(w.Z,{autoComplete:r,disabled:n,label:t,meta:{error:null===q||void 0===q?void 0:q[s],touched:!(null===q||void 0===q||!q[s])},onChange:function(e){U(!1),L((function(r){return C(C({},r),{},(0,o.Z)({},s,e.target.value))}))},primary:!0,required:i,setContentOnMount:!0,type:u,value:(null===A||void 0===A?void 0:A[s])||""})},s)}))]}),(0,x.jsx)(f.Z,{mt:5,children:(0,x.jsxs)(c.ZP,{children:[(0,x.jsx)(a.ZP,{disabled:T||q&&!(0,_.Qr)(q),loading:ne,onClick:function(){var e,r=C({},A);"roles_new"in r&&(r.roles_new=null===(e=A.roles_new)||void 0===e?void 0:e.map((function(e){return e.id})));re({user:r})},primary:!0,children:P?"Create new user":"Update user profile"}),E&&B&&(0,x.jsx)(f.Z,{ml:1,children:(0,x.jsx)(a.ZP,{danger:!0,loading:ue,onClick:function(){window.confirm("Are you sure you want to delete ".concat(A.username||A.email,"?"))&&ie()},children:"Delete user"})})]})})]})]})}},5178:function(e,r,n){"use strict";n.r(r),n.d(r,{default:function(){return T}});var o=n(77837),t=n(38860),i=n.n(t),u=n(82684),s=n(34376),l=n(93808),a=n(38276),d=n(36043),c=n(75582),v=n(21831),p=n(82394),f=n(21764),m=n(69864),w=n(71180),b=n(31882),h=n(55485),j=n(44085),Z=n(75499),y=n(30160),O=n(35686),_=n(86735),g=n(72619),x=n(28598);function P(e,r){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),n.push.apply(n,o)}return n}function C(e){for(var r=1;r<arguments.length;r++){var n=null!=arguments[r]?arguments[r]:{};r%2?P(Object(n),!0).forEach((function(r){(0,p.Z)(e,r,n[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):P(Object(n)).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))}))}return e}var k=function(e){e.fetchUser;var r=e.user,n=e.workspaces,o=(0,s.useRouter)(),t=(0,u.useState)(),i=t[0],l=t[1],d=(0,u.useState)(!0),P=d[0],k=d[1];(0,u.useEffect)((function(){r&&l(r)}),[r]);var S=null===n||void 0===n?void 0:n.map((function(e){return e.project_uuid})),E=O.ZP.roles.list({entity:"project",entity_ids:S},{},{}),D=E.data,I=(E.mutate,(0,u.useCallback)((function(e){return null===e||void 0===e?void 0:e.reduce((function(e,r){var n,o=e;return null===r||void 0===r||null===(n=r.permissions)||void 0===n||n.forEach((function(e){var n=e.entity_id,t=o[n]||[];o=C(C({},o),{},(0,p.Z)({},n,[].concat((0,v.Z)(t),[r])))})),o}),{})}),[])),M=(0,u.useMemo)((function(){var e=(null===D||void 0===D?void 0:D.roles)||[];return I(e)}),[D,I]),T=(0,u.useMemo)((function(){var e=i||r,n=null===e||void 0===e?void 0:e.roles_new;return I(n)}),[I,i,r]),U=(0,m.Db)(O.ZP.users.useUpdate(null===r||void 0===r?void 0:r.id),{onSuccess:function(e){return(0,g.wD)(e,{callback:function(){o.push("/manage/users")},onErrorCallback:function(e){var r=e.error,n=r.errors,o=r.exception,t=r.message,i=r.type;f.Am.error((null===n||void 0===n?void 0:n.error)||o||t,{position:f.Am.POSITION.BOTTOM_RIGHT,toastId:i})}})}}),N=(0,c.Z)(U,2),q=N[0],R=N[1].isLoading;return(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(a.Z,{p:2,children:(0,x.jsx)(w.ZP,{disabled:P,loading:R,onClick:function(){var e,r=C(C({},i),{},{roles_new:null===i||void 0===i||null===(e=i.roles_new)||void 0===e?void 0:e.map((function(e){return e.id}))});q({user:r})},primary:!0,children:"Update workspace roles"})}),(0,x.jsx)(Z.Z,{columnFlex:[1,1],columns:[{uuid:"Workspace"},{uuid:"Role"}],rows:null===n||void 0===n?void 0:n.map((function(e){var r=e.name,n=e.project_uuid,o=(null===M||void 0===M?void 0:M[n])||[],t=null===T||void 0===T?void 0:T[n];return[(0,x.jsx)(y.ZP,{bold:!0,children:r},"name"),(0,x.jsxs)(x.Fragment,{children:[(0,x.jsx)(j.Z,{label:"Roles",onChange:function(e){k(!1);var r=(0,_.sE)(o,(function(r){return r.id==e.target.value}));r&&l((function(e){var n,o=(null===e||void 0===e||null===(n=e.roles_new)||void 0===n?void 0:n.filter((function(e){return e.id!=(null===r||void 0===r?void 0:r.id)})))||[],t={roles_new:[].concat((0,v.Z)(o),[r])};return C(C({},e),t)}))},primary:!0,setContentOnMount:!0,children:o.map((function(e){var r=e.id,n=e.name;return(0,x.jsx)("option",{value:r,children:n},n)}))},"project_role"),(0,x.jsx)(a.Z,{mb:1}),(0,x.jsx)(h.ZP,{alignItems:"center",flexWrap:"wrap",children:null===t||void 0===t?void 0:t.map((function(e){var r=e.id,n=e.name;return(0,x.jsx)(a.Z,{mb:1,mr:1,children:(0,x.jsx)(b.Z,{label:n,onClick:function(){k(!1),l((function(e){return C(C({},e),{},{roles_new:(0,_.Od)(t,(function(e){return e.id===r}))})}))},primary:!0})},"user_roles/".concat(n))}))})]})]}))})]})},S=n(59533),E=n(70515),D=n(14875),I=n(75083);function M(e){var r=e.user,n=(0,s.useRouter)(),o=(0,u.useState)(null),t=o[0],i=o[1],l=null===r||void 0===r?void 0:r.id,c=O.ZP.users.detail(l),v=c.data,p=c.mutate,f=O.ZP.statuses.list().data,m=(0,u.useMemo)((function(){var e,r;return null===f||void 0===f||null===(e=f.statuses)||void 0===e||null===(r=e[0])||void 0===r?void 0:r.instance_type}),[f]),w=(0,u.useMemo)((function(){return null===v||void 0===v?void 0:v.user}),[v]);(0,u.useEffect)((function(){(0,g.bB)(v,i)}),[v]);var b=O.ZP.workspaces.list({cluster_type:m,user_id:l},{refreshInterval:5e3,revalidateOnFocus:!0}).data,h=(0,u.useMemo)((function(){return(0,x.jsx)(a.Z,{p:E.cd,children:(0,x.jsx)(d.Z,{hideFields:[D.s7],onDeleteSuccess:function(){return n.push("/manage/users")},onSaveSuccess:function(){return n.push("/manage/users")},showDelete:!0,title:"Edit user",user:w})})}),[n,w]),j=(0,u.useMemo)((function(){return null===b||void 0===b?void 0:b.workspaces}),[b]);return(0,x.jsx)(S.Z,{before:h,breadcrumbs:[{label:function(){return"Workspaces"},linkProps:{as:"/manage",href:"/manage"}},{label:function(){return"Users"},linkProps:{as:"/manage/users",href:"/manage/users"}},{bold:!0,label:function(){return(null===w||void 0===w?void 0:w.username)||"User"}}],errors:t,pageName:I.L6.USERS,children:(0,x.jsx)(k,{fetchUser:p,user:w,workspaces:j})})}M.getInitialProps=function(){var e=(0,o.Z)(i().mark((function e(r){var n;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=r.query.user,e.abrupt("return",{user:{id:n}});case 2:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}();var T=(0,l.Z)(M)},11976:function(e,r,n){(window.__NEXT_P=window.__NEXT_P||[]).push(["/manage/users/[user]",function(){return n(5178)}])}},function(e){e.O(0,[1557,1598,9774,2888,179],(function(){return r=11976,e(e.s=r);var r}));var r=e.O();_N_E=r}]);